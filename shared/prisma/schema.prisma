generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String             @db.VarChar(255)
  avatar        String?
  username      String?            @unique
  signature     String?            @unique
  signedMessage String?
  publicKey     String?
  signDate      DateTime?
  acceptedTerms Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  shortLink     String?            @unique
  coverImage    String?
  accountStatus Boolean            @default(false)
  point         Int                @default(0)
  twitterId     String?             @unique
  teleId        String?
  referrer      User?              @relation("UserReferral", fields: [referrerId], references: [id])
  referrerId    String?
  referees      User[]             @relation("UserReferral")
  logs          UserActivityLogs[]
  loginHistory  CheckinHistory[]

  @@id([id])
  @@map("users")
}

model Platform {
  id        String             @id @default("base")
  name      String
  criterias PlatformCriteria[]
}

model Criteria {
  id          Int                @id @default(autoincrement())
  description String?
  rate       Float                @default(0)
  platform    PlatformCriteria[]
}

model PlatformCriteria {
  criteria     Criteria           @relation(fields: [criteriaId], references: [id])
  criteriaId   Int
  platform     Platform           @relation(fields: [platformId], references: [id])
  platformId   String
  logs         UserActivityLogs[]
  lastIdSynced String?
  query       Json?
  isDaily     Boolean             @default(false)
  id          String              @default(uuid()) @id
}

model UserActivityLogs {
  user       User             @relation(fields: [userId], references: [id])
  userId     String
  task       PlatformCriteria @relation(fields: [taskId], references: [id])
  taskId      String
  time       DateTime         @default(now())
  pointClaimed  Int           

  @@id([userId,taskId])
  @@index([time(sort: Desc)])
}

model CheckinHistory {
  id      Int      @id @default(autoincrement())
  userId  String
  loginAt DateTime @default(now())
  user    User     @relation(fields: [userId], references: [id])

  @@map("login_histories")
  @@index([userId, loginAt(sort: Desc)])
}
